<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>你要下班了！</title>
<link rel="stylesheet" type="text/css" href="./static/css/bootstrap.min.css" />
<style type="text/css">
    :root {
        --background-image: #000;
    }
	#clock {
		font: bold 24pt sans;
		background-color: #f5f5f5;
		padding: 10px 15px;
		border: 1px solid #ccc;
		border-radius: 5px;
	}
	#todaydatetime {
		font: bold 24pt sans;
		background-color: #f5f5f5;
		padding: 10px 15px;
		border: 1px solid #ccc;
		border-radius: 5px;
	}
	.demo {
		margin:0,auto;
	}
	div.example{
		width:8%;
		margin:0 auto;
		padding:5px;
		border:1px solid #d4d4d4;
	}
    table {
        text-align: center;
    }
    #background {
        background-size: cover;
        background-image: var(--background-image);
    }
</style>
</head>
<body id="background">
	<div class="container">
		<div class="row">
			<div class="demo col-sm-12">
				<center>
					<h1 class=" alert alert-success">又是忙碌的一天，请按时下班~~</h1>
				</center>

				<center>
					<div class=" alert alert-success">
						<span id="todaydatetime"></span>
					</div>
					<div class=" alert alert-danger">
						<span id="clock"></span>
					</div>
                    <a href="javascript:void(0);" onclick="setTime()">自定义下班时间</a>
				</center>
			</div>
			<div >
				<script>
					var H='....';
					var H=H.split('');
					var M='.....';
					var M=M.split('');
					var S='......';
					var S=S.split('');
					var Ypos=0;
					var Xpos=0;
					var Ybase=8;
					var Xbase=8;
					var dots=12;

					function clock(){
                        var time=new Date ();
                        var secs=time.getSeconds();
                        var sec=-1.57 + Math.PI * secs/30;
                        var mins=time.getMinutes();
                        var min=-1.57 + Math.PI * mins/30;
                        var hr=time.getHours();
                        var hrs=-1.57 + Math.PI * hr/6 + Math.PI*parseInt(time.getMinutes())/360;
                        
                        setTimeout('clock()',50);
					}
					window.onload=clock;
				</script>

				<script>
                    var saved = localStorage.getItem("hourtime");
                    if (saved == null) {
                        var hourtime = "18:00:00";
                    } else {
                        var hourtime = saved;
                    }
					
					var weeks = new Array("周日", "周一", "周二", "周三", "周四", "周五", "周六");
					var holidays = {
                        "除夕": get_day("2024/02/09"),
                        "过年": [get_time("2024/02/10 00:00:00"), get_time("2024/02/17 23:59:59")],
                        "清明节": [get_time("2024/04/04 00:00:00"), get_time("2024/04/06 23:59:59")],
						"劳动节": [get_time("2024/05/01 00:00:00"), get_time("2021/05/05 23:59:59")],
						"端午节": [get_time("2024/06/08 00:00:00"), get_time("2024/06/10 23:59:59")],
						"中秋节": [get_time("2024/09/14 00:00:00"), get_time("2024/09/17 23:59:59")],
						"国庆节": [get_time("2024/10/01 00:00:00"), get_time("2021/10/07 23:59:59")],
					};
					var holiday = null;

                    function get_time(a) {
                        return new Date(a).getTime() / 1000;
                    }

					function get_day(a) {
						return [new Date(a + " 00:00:00").getTime() / 1000, new Date(a + " 23:59:59").getTime() / 1000]
					}

					function displayTime() {
						var elt = document.getElementById("clock");
						var elt2 = document.getElementById("todaydatetime");
						if(leftTime < 0) {
							elt.innerHTML = "Over";
						} else {
							var endTime =new Date(new Date().toLocaleDateString()+" "+hourtime);
							var now = new Date();
							
							var day = now.getDay();
							var nowTimestamp = new Date().getTime() / 1000;
							for(var key in holidays){
								if (nowTimestamp > holidays[key][0] && nowTimestamp < holidays[key][1]) {
									holiday = key;
								}
							}

							var nowYear=now.getFullYear();
							var nowMonth=now.getMonth()+1;
							var nowDay=now.getDate();

							var leftTime = endTime.getTime() - now.getTime();
							var ms = parseInt(leftTime % 1000).toString();
							leftTime = parseInt(leftTime / 1000);
							var o = Math.floor(leftTime / 3600);
							var d = Math.floor(o / 24);
							var m = Math.floor(leftTime / 60 % 60);
							var s = leftTime % 60;

							elt2.innerHTML = nowYear + " 年 " + nowMonth + " 月 " + nowDay + " 日 ";
							if (holiday != null){
								elt.innerHTML = "不是吧阿Sir？" + holiday + "还上班？";
							} else if ( day == 6 || day == 0){
								elt.innerHTML = "不是吧阿Sir？" + weeks[day] + "还上班？";
							} else if ((o<0&&m<0&&s<0)){
								elt.innerHTML = "你已经下班了，为什么还不回家？";
							} else {
								elt.innerHTML = o + "小时:" + m + "分:" + s + "秒:" + ms.charAt(0);
							}
							setTimeout(displayTime, 100);
						}
					}
					displayTime();

                    function setTime() {
                        var curr = localStorage.getItem("hourtime");
                        if (curr == null) {
                            curr = "18:00:00";
                        }
                        var value = prompt("设置下班时间，格式参考：18:00:00", curr);
                        if (value != null) {
                            localStorage.setItem("hourtime", value);
                            location.reload();
                        }
                    }
				</script>
			</div>
            <table class="table table-condensed">
                <thead>
                    <tr>
                        <th>更新时间</th>
                        <th>所在城市</th>
                        <th>湿度</th>
                        <th>空气质量</th>
                        <th>天气</th>
                        <th>温度</th>
                        <th>最高温度</th>
                        <th>最低温度</th>
                        <th>风向</th>
                        <th>风力</th>
                        <th>风速</th>
                        <th>气压</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="update_time"></td>
                        <td id="city"></td>
                        <td id="humidity"></td>
                        <td id="air"></td>
                        <td id="wea"></td>
                        <td id="tem"></td>
                        <td id="tem_day"></td>
                        <td id="tem_night"></td>
                        <td id="win"></td>
                        <td id="win_speed"></td>
                        <td id="win_meter"></td>
                        <td id="pressure"></td>
                    </tr>
                </tbody>
              </table>
		</div>
	</div>
	
</body>
</html>
<script>
    function parseWeather(result) {
        const backgroundElement = document.querySelector("html");
        // backgroundElement.style.setProperty("--background-image", "url('./static/imgs/" + result.wea_img + ".jpg')");
        document.getElementById("update_time").innerHTML = result.update_time;
        document.getElementById("city").innerHTML = result.city;
        document.getElementById("humidity").innerHTML = result.humidity;
        document.getElementById("air").innerHTML = result.air;
        document.getElementById("wea").innerHTML = result.wea;
        document.getElementById("tem").innerHTML = result.tem;
        document.getElementById("tem_day").innerHTML = result.tem_day;
        document.getElementById("tem_night").innerHTML = result.tem_night;
        document.getElementById("win").innerHTML = result.win;
        document.getElementById("win_speed").innerHTML = result.win_speed;
        document.getElementById("win_meter").innerHTML = result.win_meter;
        document.getElementById("pressure").innerHTML = result.pressure;
    }

    function getWeather() {
        var cookies = document.cookie.split(";");
        var cookies = cookies[0].split(",")

        const appid = cookies[0].split("=")[1];
        const appsecret = cookies[1].split("=")[1];

        const xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                const result = JSON.parse(xhr.responseText);
                const timestamp = new Date().getTime();
                localStorage.setItem("weather", JSON.stringify(result));
                localStorage.setItem("weather_expire", timestamp + 1000 * 60 * 60);
                parseWeather(result);
            }
        };
        xhr.open('GET', 'http://v1.yiketianqi.com/free/day?appid=' + appid + '&appsecret=' + appsecret + '&unescape=1', true);
        xhr.send();
    }

    var weather_expire = localStorage.getItem("weather_expire");
    var now = new Date().getTime();
    if (weather_expire === undefined || weather_expire === null || weather_expire < now) {
        localStorage.removeItem("weather");
    }

    var weather = localStorage.getItem("weather");
    if (weather != null) {
        var result = JSON.parse(weather);
        parseWeather(result);
    } else {
        getWeather();
    }
</script>
